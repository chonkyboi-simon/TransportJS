<!DOCTYPE html>
<html>
<head>
  <title>TCP Relay Tool</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      background-color: #ffffff;
      color: #000000;
    }

    body {
      display: flex;
      flex-direction: column;
      font-family: sans-serif;
      font-size: 10px;
      transition: background 0.4s ease, color 0.4s ease;
    }

    h1, h2 {
      color: #000000;
    }

    input {
      background: #f0f0f0;
      color: #000;
      border: 1px solid #aaa;
      padding: 0.4rem;
      font-size: 0.5em;
      border-radius: 5px;
      width: 200px;
    }

    button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-size: 0.5em;
      font-weight: bold;
      color: #000;
      background: #ddd;
      border: 1px solid #aaa;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background: #ccc;
    }

    #controls {
      padding: 1.5rem;
      flex-shrink: 0;
    }

    #log {
      flex-grow: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 1rem;
      white-space: pre-wrap;
      background: #f4f4f4;
      color: #000;
    }

    .log-entry {
      margin-bottom: 1rem;
    }

    .headline {
      font-weight: bold;
      color: #000;
    }

    .message {
      margin-left: 1rem;
      white-space: pre-wrap;
      word-break: break-word;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="controls">
    <h1>TCP Relay Tool</h1>
    <div>
      <label>Listen Port: <input id="listenPort" type="number" value="9000" /></label><br/>
      <label>Target Host: <input id="targetHost" value="127.0.0.1" /></label><br/>
      <label>Target Port: <input id="targetPort" type="number" value="80" /></label><br/>
      <button id="toggleButton">Start Relay</button><br/><br/>
      <label>
        <input type="checkbox" id="holdToggle" />
        Hold Mode
      </label>
    </div>
    <h2>Log Feed</h2>
  </div>

  <pre id="log"></pre>

  <div id="holdEditor" style="padding: 1rem; background: #fafafa; border-top: 1px solid #ccc;">
    <h3>Review / Edit Packet</h3>
    <textarea id="editBox" rows="5" style="width: 100%; font-family: monospace;"></textarea><br/>
    <button id="forwardBtn">Forward Edited Packet</button>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const button = document.getElementById('toggleButton');
    const socket = new WebSocket('ws://' + location.host);
    let isRunning = false;

    socket.onmessage = (event) => {
      try {
        const { headline, message } = JSON.parse(event.data);
        appendLog(headline, message);
      } catch (err) {
        appendLog('Malformed Log', event.data);
      }
    };

    function appendLog(headline, message) {
      console.log("appendLog() is invoked.");

      const entry = document.createElement('div');
      entry.className = 'log-entry';

      const h = document.createElement('div');
      h.className = 'headline';
      h.textContent = headline;

      const m = document.createElement('div');
      m.className = 'message';
      m.textContent = message;

      entry.appendChild(h);
      entry.appendChild(m);
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;

      // Detect hold-mode logs
      if (headline === 'Device → Server' || headline === 'Server → Device') {
        if (holdToggle.checked) {
          latestHoldPacket = {
            direction: headline === 'Device → Server' ? 'deviceToServer' : 'serverToDevice',
            dataHex: message
          };
          editBox.value = message;
        }
      }
    }


    async function startRelay() {
      const listenPort = parseInt(document.getElementById('listenPort').value);
      const targetHost = document.getElementById('targetHost').value;
      const targetPort = parseInt(document.getElementById('targetPort').value);

      const response = await fetch('/tool_start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ listenPort, targetHost, targetPort })
      });

      if (response.ok) {
        isRunning = true;
        button.textContent = 'Stop Relay';
      } else {
        const err = await response.json();
        alert('Failed to start relay: ' + err.error);
      }
    }

    async function stopRelay() {
      const response = await fetch('/tool_stop', { method: 'POST' });
      if (response.ok) {
        isRunning = false;
        button.textContent = 'Start Relay';
      } else {
        const err = await response.json();
        alert('Failed to stop relay: ' + err.error);
      }
    }

    button.addEventListener('click', () => {
      if (isRunning) {
        stopRelay();
      } else {
        startRelay();
      }
    });

    const holdToggle = document.getElementById('holdToggle');
    const editBox = document.getElementById('editBox');
    const forwardBtn = document.getElementById('forwardBtn');

    let latestHoldPacket = null;

    holdToggle.addEventListener('change', async () => {
      const enabled = holdToggle.checked;
      await fetch('/set_hold_mode', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled })
      });
    });

    forwardBtn.addEventListener('click', async () => {
      if (!latestHoldPacket) return;

      const editedHex = editBox.value.trim();
      const response = await fetch('/forward_packet', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          direction: latestHoldPacket.direction,
          dataHex: editedHex
        })
      });

      if (response.ok) {
        appendLog('Forwarded', `Sent to ${latestHoldPacket.direction}`);
        latestHoldPacket = null;
        editBox.value = '';
      }
    });

  </script>
</body>
</html>
